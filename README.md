# 通信测试上位机

一个基于Python的多功能通信测试工具，支持TCP客户端、串口调试、RS485协议测试和USB设备通信。现已提供 PySide6 Qt 版本界面（`qt_app.py`）。

## 功能特性

### 1. TCP通信
- 支持客户端和服务端模式
- 客户端模式：连接到TCP服务器
- 服务端模式：监听端口，支持多客户端连接
- 多个发送框，支持文本和HEX格式
- 实时数据接收显示，显示数据来源
- 连接状态监控

### 2. UDP通信
- 支持客户端和服务端模式
- 广播和组播功能
- 多目标发送
- 显示数据来源地址
- 10个发送框，支持文本和HEX格式

### 3. 串口调试
- 自动检测可用串口
- 支持多种波特率、数据位、校验位、停止位配置
- 多个发送框，支持文本和HEX格式
- 可选择是否添加换行符
- 实时数据接收显示

### 4. RS485协议测试
- 专门针对RS485通信优化
- 内置Modbus RTU协议支持
- 自动CRC16校验计算
- 协议帧自动生成
- 支持常用功能码（01, 02, 03, 04, 05, 06, 15, 16）
- 接收数据自动解析

### 5. USB设备通信
- 自动检测USB设备
- 支持自定义VID/PID
- 端点配置
- 批量数据传输
- 测试数据快速填充

## 安装和运行

### 1. 安装依赖
```bash
# 方法1：使用批处理文件（Windows）
install_dependencies.bat

# 方法2：手动安装
pip install -r requirements.txt
```

### 2. 运行程序
```bash
# 方法1：使用批处理文件（Windows）
run.bat

# 方法2：直接运行
python main.py

# 方法3：PySide6 预览界面
run_qt.bat

或直接运行：
python qt_app.py

## 改动概览（2025-11）
- 持久化窗口位置、大小与最大化状态，移动/缩放自动保存（Qt版）。
- 配置中新增 `esp32_log` 的保存/加载（Qt版）。
- 将通用基础标签页与 ESP32 日志标签页拆分至 `app` 包（Qt版）。
- 清理无用旧脚本（Tkinter 版本与早期模块）。
- 支持用 PyInstaller 打包为单个 Windows 可执行文件（Qt版）。

## 打包为单个 exe（Windows）
- 安装依赖：`pip install -r requirements.txt`
- 安装打包器：`pip install pyinstaller`
- 运行打包脚本：`packaging\build_exe.bat`
- 生成的文件位置：`dist\TcpTool.exe`

备注：应用在打包运行时，会将配置文件 `config.json` 写入与 `TcpTool.exe` 同目录，以确保便携和持久化设置生效。
```

## 依赖库

- `pyserial`: 串口通信支持
- `pyusb`: USB设备通信支持
- `tkinter`: GUI界面（Python内置）
- `PySide6`: 新版 Qt 界面预览
- `pywebview`: Web 前端预览（可选）

## 使用说明

### TCP通信使用
**客户端模式：**
1. 选择"客户端"模式
2. 输入服务器地址和端口
3. 点击"连接"按钮
4. 在发送框中输入数据
5. 选择文本或HEX格式
6. 点击"发送"按钮

**服务端模式：**
1. 选择"服务端"模式
2. 设置监听地址、端口和最大连接数
3. 点击"启动服务"按钮
4. 在发送框中选择目标客户端（或"全部"）
5. 输入数据并发送

### UDP通信使用
1. 选择工作模式（客户端/服务端）
2. 配置本地和远程地址端口
3. 可选择广播或组播模式
4. 点击"启动"按钮
5. 在发送框中输入数据和目标地址
6. 点击"发送"或"广播"按钮

### 串口调试使用
1. 选择串口和配置参数
2. 点击"打开串口"
3. 在发送框中输入数据
4. 选择格式和是否添加换行符
5. 点击"发送"按钮

### RS485测试使用
1. 选择串口和波特率
2. 设置设备地址
3. 选择功能码和参数
4. 点击"生成"自动生成Modbus帧
5. 点击"发送"发送数据

### USB通信使用
1. 刷新并选择USB设备
2. 配置VID、PID和端点地址
3. 点击"连接设备"
4. 在发送框中输入数据或使用测试数据
5. 点击"发送"按钮

## 配置保存

程序会自动保存所有配置到 `config.json` 文件，包括：
- 连接参数
- 发送框数据
- 界面设置

下次启动时会自动加载上次的配置。

## 注意事项

1. **串口权限**: 在某些系统上可能需要管理员权限才能访问串口
2. **USB驱动**: USB通信需要正确安装设备驱动
3. **防火墙**: TCP连接可能被防火墙阻止
4. **设备占用**: 确保设备没有被其他程序占用

## 故障排除

### 串口无法打开
- 检查串口是否被其他程序占用
- 确认串口参数设置正确
- 尝试以管理员权限运行程序

### USB设备连接失败
- 检查设备驱动是否正确安装
- 确认VID/PID和端点地址正确
- 尝试重新插拔USB设备

### USB后端不可用（No backend available）
在 Windows 上使用 PyUSB 需要 libusb 后端和设备的 WinUSB 驱动：

1. 安装库文件（libusb-1.0.dll）
   - 下载与系统架构匹配的 `libusb-1.0.dll`（x64 对应 64 位 Python）。
   - 将 `libusb-1.0.dll` 放到以下任一位置：
     - `C:\Windows\System32`（x64）或 `C:\Windows\SysWOW64`（x86），或
     - Python 安装目录下，例如 `...\PythonXX\DLLs`，或
     - 本项目目录（与 `main.py` 同目录）。

2. 为目标设备安装 WinUSB 驱动（Zadig）
   - 下载并运行 Zadig 工具。
   - 选择你的设备，在驱动下拉框中选择 `WinUSB`。
   - 点击 `Install Driver` 完成安装。

3. 验证后端是否可用
   - 运行：
     - `python -c "import usb.backend.libusb1 as b; print(bool(b.get_backend()))"`
   - 输出 `True` 表示后端已就绪。

如果依旧提示“未检测到 libusb 后端”，请确认 DLL 文件路径正确且与 Python 位数匹配，并确保设备已切换为 WinUSB 驱动。

### TCP连接失败
- 检查服务器地址和端口是否正确
- 确认网络连接正常
- 检查防火墙设置

## 开发信息

- 开发语言: Python 3.x
- GUI框架: Tkinter
- 支持平台: Windows, Linux, macOS

## 版本历史

- v1.0: 初始版本，支持TCP、串口、RS485、USB通信
- v1.1: 新增UDP通信功能，支持客户端/服务端模式、广播、组播
- v1.2: TCP模块升级，新增服务端模式，支持多